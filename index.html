<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UTBK AI Mentor Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']] 
        }
      };
    </script>
    
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0F172A; --accent: #3B82F6; --bg: #F8FAFC; --card: #FFFFFF; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; min-height: 100vh; display: flex; justify-content: center; color: #334155; }
        .container { background: var(--card); width: 100%; max-width: 600px; min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.05); }
        @media (min-width: 600px) { .container { min-height: auto; border-radius: 24px; padding: 25px; margin: 30px 20px; height: auto; } }

        /* HEADER */
        .brand-header { padding: 25px; text-align: center; border-bottom: 1px solid #e2e8f0; }
        .brand-title { margin: 0; color: var(--primary); font-size: 1.4rem; font-weight: 700; }

        /* PAGES */
        .page { display: none; padding: 20px; animation: slideUp 0.4s ease-out; }
        .active { display: block; }
        @keyframes slideUp { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }

        /* UI ELEMENTS */
        .token-input { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1.1rem; text-align: center; margin: 20px 0; letter-spacing: 3px; text-transform: uppercase; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 600; width: 100%; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn-ai { background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; color: white; margin-top: 15px; }
        
        /* QUIZ */
        .wacana-box { background: #f1f5f9; padding: 18px; border-radius: 12px; margin-bottom: 20px; line-height: 1.8; font-size: 0.95rem; border-left: 4px solid var(--accent); overflow-wrap: break-word; }
        .soal-image { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; display:block; }
        .option-btn { width: 100%; padding: 16px; margin-bottom: 12px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; text-align: left; cursor: pointer; display: flex; align-items: flex-start; }
        .option-btn span { margin-right: 12px; font-weight: bold; color: var(--accent); min-width: 20px; flex-shrink: 0; }
        
        .correct { background: #ecfdf5 !important; border-color: #10b981 !important; color: #047857; }
        .wrong { background: #fef2f2 !important; border-color: #ef4444 !important; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 12px; display: none; font-size: 0.95rem; }
        
        .fb-clue { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; }
        .fb-correct { background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d; }
        .fb-wrong { background: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; }
        
        #ai-result { text-align: left; background: #fdf4ff; border: 1px solid #f0abfc; padding: 20px; border-radius: 12px; margin-top: 20px; display: none; font-size: 0.9rem; line-height: 1.6; }

        /* MENU GRID */
        #menu-list { display: grid; gap: 15px; }
        .btn-menu { background: white; border: 2px solid #e2e8f0; color: var(--primary); padding: 20px; border-radius: 16px; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .btn-menu:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }/* ... kode css lama ... */

        /* üëá ANIMASI LOADING & TEKS BERKEDIP üëá */
        .loader {
            border: 5px solid #f3f3f3; /* Abu-abu pudar */
            border-top: 5px solid var(--accent); /* Biru Utama */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: putar 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes putar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .loading-text {
            color: var(--accent);
            font-weight: 600;
            text-align: center;
            animation: kedip 1.5s infinite;
        }
        @keyframes kedip { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

#quiz-container {
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }


    </style>
</head>
<body>

<div class="container">
    <div class="brand-header">
        <h1 class="brand-title">üéì MENTOR UTBK <span style="color:var(--accent)">AI</span></h1>
    </div>

    <div id="p-login" class="page active" style="text-align: center; padding-top: 30px;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üîí</div>
        <h2>Akses Premium</h2>
        <input type="text" id="token-input" class="token-input" placeholder="KODE AKSES">
        <button class="btn-primary" onclick="cekToken()">MASUK</button>
        <p id="error-msg" style="color: #ef4444; display: none; margin-top: 15px; font-weight: 600;"></p>
        <p style="color:#94a3b8; font-size: 0.85rem; margin-top: 30px;">Pass: <b>LULUS-UTBK</b></p>
    </div>

    <div id="p-menu" class="page">
        <h2 style="margin-bottom: 20px;">Pilih Mapel üìö</h2>
        <div id="menu-list"></div>
    </div>

    <div id="p-quiz" class="page">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center;">
            <span id="progress" style="font-weight: 600; color: #64748b;">Soal 1</span>
            <span id="timer" style="background: #fee2e2; color: #ef4444; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9rem;">00:00</span>
        </div>
        <div id="q-area"></div>
        <div id="feedback" class="feedback"></div>
        <button id="btn-next" class="btn-primary" style="margin-top:20px; display:none;" onclick="nextQuestion()">LANJUT ‚ûî</button>
    </div>

    <div id="p-score" class="page" style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 10px;">üèÜ</div>
        <h2 style="margin:0;">Selesai!</h2>
        <h1 id="final-score" style="font-size: 3.5rem; color: var(--primary); margin: 10px 0;">0</h1>
        <p style="color: #64748b;">Skor UTBK Kamu</p>
        
        <button id="btn-analyze" class="btn-primary btn-ai" onclick="tanyaAI()">
            ‚ú® Evaluasi Hasil Saya (AI)
        </button>
        <div id="ai-loading" style="display:none; margin-top:15px; color:#6366f1;"></div>
        <div id="ai-result"></div>

        <button class="btn-primary" style="background: white; color: #333; border: 1px solid #ddd; margin-top: 15px;" onclick="location.reload()">Menu Utama</button>
    </div>
</div>

<script>
    // ================= CONFIG =================
    const PASSWORD = "LULUS-UTBK";
    
    // ‚úÖ KUNCI YANG SUDAH TERBUKTI VALID
    const API_KEY_GEMINI = "AIzaSyCWkYkUsyxhvF0w8g3poZYmPueDidgrLek"; 

    // üëá FITUR BARU: BATASI JUMLAH SOAL üëá
    const JUMLAH_SOAL_MAX = 15; // Cuma 15 soal per sesi (meski di CSV ada 100)
    
    // ======================================================
    // üëáüëáüëá UPDATE LINK CSV KAMU DI SINI üëáüëáüëá
    const DAFTAR_PAKET = {
        "üß† Penalaran Umum": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTWXZoyNTnAX-0uTm6eb_zDNk20GGFjuWQtO2UBz9b-IZSF1y4Wc_ZXJGE7zUI_394LnYFJNHWKs5a/pub?gid=0&single=true&output=csv",
        "üìê Pengetahuan Kuantitatif": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS2QQqQK2YHMHFYDfDSCWEYieBobUy0Xh21S13BIU0C1cKG4xvSkYuAdJSLNUs1LBdVm0S5dr1r_p0X/pub?gid=0&single=true&output=csv", // Pastikan link ini mengarah ke Sheet Kuantitatif
        "üìñ Literasi Bahasa Inggris": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS2vVvZZcN8doZ-hrB-fak6KhP0L69d0T-1MDlToCXeNF3RknJRoiUJDeATeeo68tya2N-VOKQNwK4o/pub?gid=0&single=true&output=csv"
    };
    // ======================================================

    let dataSoal = [], userHistory = [], currentIdx = 0, score = 0, nyawa = 1, timerInterval, seconds = 0;

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function cekToken() {
        if(document.getElementById('token-input').value.toUpperCase().trim() === PASSWORD) {
            renderMenu(); showPage('p-menu');
        } else {
            document.getElementById('error-msg').style.display = 'block'; document.getElementById('error-msg').innerText = "Kode Salah!";
        }
    }

    function renderMenu() {
        const box = document.getElementById('menu-list'); box.innerHTML = '';
        for (const [nama, link] of Object.entries(DAFTAR_PAKET)) {
            box.innerHTML += `<div class="btn-menu" onclick="loadSoal('${link}')"><div><b>${nama}</b><br><small style="color:#64748b">Mulai Ujian</small></div><span>‚ûî</span></div>`;
        }
    }

function loadSoal(link) {
        if(link.includes("MASUKKAN_LINK")) return alert("Link soal belum diisi di kodingan!");
        
        const btn = event.currentTarget;
        const oriText = btn.innerHTML;
        btn.innerHTML = "‚è≥ Mengacak Soal...";
        
        Papa.parse(link, { 
            download: true, 
            header: true, 
            delimiter: ",", // <--- INI OBATNYA! Memaksa pemisah harus koma.
            complete: (res) => {
                // 1. Ambil semua soal mentah dari CSV
                let rawData = res.data.filter(r => r.Wacana || r.Pertanyaan);
                
                if(!rawData.length) { btn.innerHTML = oriText; return alert("Soal Kosong!"); }

                // 2. FITUR ACAK (SHUFFLE)
                rawData.sort(() => 0.5 - Math.random());

                // 3. FITUR BATASI (LIMIT)
                dataSoal = rawData.slice(0, JUMLAH_SOAL_MAX);

                currentIdx = 0; score = 0; seconds = 0; userHistory = [];
                startQuiz();
            }, error: () => { btn.innerHTML = oriText; alert("Gagal mengambil soal. Cek Link!"); }});
    }
    function startQuiz() {
        showPage('p-quiz'); renderQuestion();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            seconds++; let m = Math.floor(seconds/60), s = seconds%60;
            document.getElementById('timer').innerText = `${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }, 1000);
    }

    function renderQuestion() {
        const item = dataSoal[currentIdx]; nyawa = 1;
        document.getElementById('progress').innerText = `Soal ${currentIdx+1}/${dataSoal.length}`;
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('btn-next').style.display = 'none';
        
        let html = item.Gambar ? `<img src="${item.Gambar}" class="soal-image">` : '';
        if(item.Wacana) html += `<div class="wacana-box">${item.Wacana}</div>`;
        html += `<div style="font-weight:bold; margin-bottom:15px; font-size:1.1rem;">${item.Pertanyaan}</div>`;
        
        ['A','B','C','D','E'].forEach((label, i) => {
            let txt = item[`Opsi_${label}`];
            if(txt) html += `<button class="option-btn" id="opt-${i}" onclick="jawab(${i})"><span>${label}.</span> <div>${txt}</div></button>`;
        });
        document.getElementById('q-area').innerHTML = html;
        if(window.MathJax) MathJax.typesetPromise();
    }

    function jawab(pilih) {
        if(document.getElementById('btn-next').style.display === 'block') return;
        const item = dataSoal[currentIdx]; const kunci = parseInt(item.Kunci); const fb = document.getElementById('feedback');
        
        if(nyawa === 1) {
            userHistory.push({ soal: item.Pertanyaan, jawabanUser: item[`Opsi_${String.fromCharCode(65+pilih)}`], kunci: item[`Opsi_${String.fromCharCode(65+kunci)}`], isCorrect: (pilih === kunci) });
        }

        if(pilih === kunci) {
            document.getElementById(`opt-${pilih}`).classList.add('correct');
            score += (nyawa === 1 ? 20 : 10);
            fb.className = "feedback fb-correct"; fb.innerHTML = `‚úÖ <b>Benar!</b><br>${item.Pembahasan}`; fb.style.display = 'block'; document.getElementById('btn-next').style.display = 'block';
        } else {
            if(nyawa === 1) {
                document.getElementById(`opt-${pilih}`).classList.add('wrong');
                fb.className = "feedback fb-clue";
                fb.innerHTML = `üí° <b>Belum Tepat.</b><br>${item.Clue || "Cek pertanyaan lagi!"}<br><i>Silakan pilih jawaban lain!</i>`;
                fb.style.display = 'block'; nyawa = 2;
            } else {
                document.getElementById(`opt-${pilih}`).classList.add('wrong'); document.getElementById(`opt-${kunci}`).classList.add('correct');
                fb.className = "feedback fb-wrong"; fb.innerHTML = `‚ùå <b>Jawaban: ${String.fromCharCode(65+kunci)}</b><br>${item.Pembahasan}`; fb.style.display = 'block'; document.getElementById('btn-next').style.display = 'block';
            }
        }
        if(window.MathJax) MathJax.typesetPromise();
    }

    function nextQuestion() {
        if(currentIdx < dataSoal.length-1) { currentIdx++; renderSoal(); startTimer() } 
        else { clearInterval(timerInterval); showPage('p-score'); document.getElementById('final-score').innerText = Math.round((score / (dataSoal.length*20)) * 1000); }
    }

    // --- AI MENTOR (PASTI JALAN: SUDAH DISESUAIKAN DENGAN AKUNMU) ---
async function tanyaAI() {
        const btn = document.getElementById('btn-analyze');
        const loading = document.getElementById('ai-loading');
        const resultBox = document.getElementById('ai-result');
        
        // Ambil skor akhir yang tampil di layar
        const skorAkhir = document.getElementById('final-score').innerText;
        
        if(!API_KEY_GEMINI || API_KEY_GEMINI.includes("PASTE")) { alert("Key Error"); return; }

        btn.style.display = 'none';
        loading.style.display = 'block';

        // 1. TAMPILKAN ANIMASI LOADING KEREN
        loading.innerHTML = `
            <div class="loader"></div>
            <div class="loading-text">
                üß† AI sedang menganalisis performamu...<br>
                <small style="color:#64748b; font-weight:normal;">Membandingkan dengan standar PTN Favorit...</small>
            </div>
        `;

        // 2. PROMPT CANGGIH DENGAN DATA VALID
        let promptText = `
        Kamu adalah Mentor UTBK SNBT yang cerdas, suportif, dan berbasis data.
        
        DATA SKOR SISWA:
        - Skor Latihan: ${skorAkhir} (Skala 0-1000)
        
        ACUAN DATA PASSING GRADE UTBK (Gunakan ini sebagai patokan analisis):
        - Skor > 700: ZONA AMAN untuk PTN Top Tier (UI, ITB, UGM) terutama kedokteran/teknik.
        - Skor 650 - 700: KOMPETITIF untuk PTN Favorit (Unpad, Undip, ITS, UB) jurusan populer.
        - Skor 550 - 649: CUKUP untuk PTN Menengah atau jurusan yang tidak terlalu ketat.
        - Skor < 550: PERLU PERBAIKAN BESAR untuk menembus persaingan SNBT.

        TUGASMU:
        1. Analisis posisi siswa ini berdasarkan skor ${skorAkhir} dan acuan data di atas. Jujurlah apakah nilainya sudah aman atau belum.
        2. Bedah kesalahannya dari riwayat jawaban di bawah ini.
        3. Beri saran strategi belajar spesifik agar bisa naik ke level 700+.

        RIWAYAT JAWABAN SISWA:
        `;

        // Masukkan history jawaban siswa ke prompt
        userHistory.forEach((h, i) => {
            promptText += `Soal ${i+1}: ${h.soal} \n   -> Jawaban Siswa: ${h.jawabanUser} \n   -> Kunci: ${h.kunci} \n   -> Status: ${h.isCorrect ? "BENAR ‚úÖ" : "SALAH ‚ùå"}\n\n`;
        });

        const models = ["gemini-2.5-flash", "gemini-2.0-flash", "gemini-flash-latest"];
        let sukses = false;

        for (const model of models) {
            try {
                // Jangan ubah teks loading di sini biar animasinya gak hilang
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY_GEMINI}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });

                if (!res.ok) throw new Error("Gagal");
                const data = await res.json();
                
                if (data.candidates && data.candidates.length > 0) {
                    loading.style.display = 'none';
                    resultBox.style.display = 'block';
                    resultBox.innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
                    sukses = true;
                    break;
                }
            } catch (e) { console.warn(`Gagal model ${model}`); }
        }

        if (!sukses) {
            loading.style.display = 'none';
            btn.style.display = 'block';
            alert("‚ö†Ô∏è Maaf, server AI sedang sibuk. Silakan coba tekan tombol lagi dalam 1 menit.");
        }
    }

// üëáüëáüëá INI FUNGSI BARU, TARUH DI PALING BAWAH JS üëáüëáüëá
    function renderSoal() {
        // 1. Efek kedip (sembunyikan dulu)
        const container = document.getElementById('quiz-container');
        if(container) container.style.opacity = '0';

        // 2. Ambil data soal berdasarkan index saat ini
        if (!dataSoal || dataSoal.length === 0) return;
// 2. PANGGIL FUNGSI BARU KITA
    renderSoal();  //            
            // Reset tampilan tombol
            btn.className = "option-btn w-full text-left p-4 rounded-xl border-2 border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all mb-3 relative group";
            btn.disabled = false;
            btn.onclick = () => cekJawaban(opt); // Pasang fungsi klik
            
            // Isi teks opsi
            let cleanText = marked.parse(soal[textKey] || "").replace(/<p>|<\/p>/g, "");
            
            btn.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">${opt}.</span>
                    <span class="flex-1">${cleanText}</span>
                </div>
            `;
        });

        // 8. Panggil MathJax untuk merapikan rumus
        if (window.MathJax) {
            MathJax.typesetPromise([container]).then(() => {
                if(container) container.style.opacity = '1'; // Munculkan lagi
            }).catch(() => {
                if(container) container.style.opacity = '1';
            });
        } else {
            if(container) container.style.opacity = '1';
        }
    }

</script>

</body>
</html>